<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jin.mes.common.attach.AttachMgtMapper">
	
	<sql id="attachBase">
		attach_id		AS attachId,
			attach_target	AS attachTarget,
			attach_code     AS attachCode,
			attach_path     AS attachPath,
			attach_location	AS attachLocation,
			attach_origin   AS attachOrigin,
			attach_filename AS attachFilename,
			attach_size     AS attachSize,
			attach_ext      AS attachExt,
			img_yn          AS imgYn,
			img_width       AS imgWidth,
			img_height      AS imgHeight,
			creator_id      AS creatorId,
			created_at      AS createdAt
		FROM cw_attach_mgt
		WHERE 1=1
		<if test="attachId != null and attachId != '' ">
			AND attach_id = #{attachId}
		</if>
		<if test="attachTarget != null and attachTarget != '' ">
			AND attach_target = #{attachTarget}
		</if>
		<if test="attachCode != null and attachCode != '' ">
			AND attach_code = #{attachCode}
		</if>
	</sql>
	
	<!-- 	첨부파일 조회 -->
	<select id="selectAttchMgtList" 
		parameterType="jin.mes.common.attach.AttachMgtDto"
		resultType="jin.mes.common.attach.AttachMgtDto">
		SELECT	
			<include refid="attachBase"/>
	</select>
	
	<!-- 	첨부파일 조회(page) -->
	<select id="selectAttchMgtPage" 
		parameterType="jin.mes.common.attach.AttachMgtDto"
		resultType="jin.mes.common.attach.AttachMgtDto">
			SELECT * FROM (
				SELECT 
					<choose>
						<when test="sort != null and sort != '' ">
							ROW_NUMBER() OVER(ORDER BY ${sort}) AS RNUM,
						</when>
						<otherwise>
							ROW_NUMBER() OVER(ORDER BY created_at desc) AS RNUM,
						</otherwise>
					</choose>
				<include refid="attachBase"/>
			)s_table
		WHERE RNUM <![CDATA[ >= ]]> #{firstIndex} AND RNUM <![CDATA[ <= ]]> #{lastIndex}
	</select>

	<!-- 	첨부파일 조회 (page-count) -->
	<select id="selectAttchMgtCount" 
		parameterType="jin.mes.common.attach.AttachMgtDto"
		resultType="java.lang.Integer">
			SELECT count(*) 
			FROM (
				SELECT
				<include refid="attachBase" />
			)c_table
	</select>
	
	<insert id="insertAttchMgt" parameterType="jin.mes.common.attach.AttachMgtDto">
		<selectKey keyProperty="attachId" resultType="java.lang.String" order="BEFORE">
			SELECT CREATE_PK('ATTACH') AS attachId
		</selectKey>
		INSERT INTO cw_attach_mgt(
			attach_id,
			attach_target,
			attach_code,
			attach_path,
			attach_location,
			attach_origin,
			attach_filename,
			attach_size,
			attach_ext,
			img_yn,
			img_width,
			img_height,
			creator_id,
			created_at
		)VALUES(
			#{attachId},
			#{attachTarget},
			#{attachCode},
			#{attachPath},
			#{attachLocation},
			#{attachOrigin},
			#{attachFilename},
			#{attachSize},
			#{attachExt},
			#{imgYn},
			#{imgWidth},
			#{imgHeight},
			#{creatorId},
			NOW()
		)
	</insert>
	
	<delete id="deleteAttchMgt" parameterType="jin.mes.common.attach.AttachMgtDto">
		DELETE FROM cw_attach_mgt
		WHERE attach_id  = #{attachId}
	</delete>
</mapper>