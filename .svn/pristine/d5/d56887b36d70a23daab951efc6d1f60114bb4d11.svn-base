<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SHIP_outReg">
<!-- 		                 , FN_CM_GETCOMNM(PI.CTR_CD , 'PRODTYPE', P.PRODTYPE) AS PRODTYPE        
			             , FN_CM_GETCOMNM(PI.CTR_CD , 'PRODSPEC', P.PRODSPEC) AS PRODSPEC        
						 , FN_CM_GETCOMNM(PI.CTR_CD , 'PRODUNITCD',P.PRODUNIT_CD )  AS UNIT_NM   -->
	<!-- 제품입고 리스트 가져오기 -->
	<select id="selectProdInList" parameterType="hashmap"
		resultType="hashmap">
		<![CDATA[
		 SELECT            PI.PROD_IN_NO                                                  	
		                 , DATE_FORMAT(PI.PROD_IN_DATE,'%Y%m%d') AS PROD_IN_DATE           	
		                 , PI.WO_OUT_NO                                                   		
		                 , PI.ORDER_NO                                                    		
		                 , PI.CUSTOMERID                                                  		
		                 , PI.PRODID                                                      		 
		                 , C.CUSTOMERNAME                                                 		
		                 , P.PRODNAME                                                     		
		                 , P.PRODMTRL													  		 
		                 , P.PRODTYPE     
			             , P.PRODSPEC       
						 , P.PRODUNIT_CD AS UNIT_NM  
		                 , PI.PROD_IN_QTY                                                 		 
		                 , PI.PROD_OUT_TOT_QTY                                            		
		                 , PI.PROD_IN_QTY - PI.PROD_OUT_TOT_QTY AS STOCK_QTY              		
		                 , PI.DEL_GBN                                                     	
			FROM TB_MESPRODIN PI
			LEFT JOIN TB_CUSTOMER C ON PI.CUSTOMERID = C.CUSTOMERID
			LEFT JOIN TB_PRODUCT P ON PI.PRODID = P.PRODID
			WHERE 1 = 1
			AND PI.PROD_IN_QTY - PI.PROD_OUT_TOT_QTY > 0    -- 입고량-총출고량=0이면 리스트에서 사라짐 
		]]>
		<!--  삭제 구분에 N 즉 삭제된 데이터가 아닌경우 -->
		<if test='DEL_GBN != "N"'>
			AND PI.DEL_GBN ='N'
		</if>
		<!-- 검색 날짜가 null이 아닐경우 -->
		<if test='STR_DT != null and STR_DT != ""'>
			AND PROD_IN_DATE BETWEEN STR_TO_DATE(#{STR_DT},'%Y%m%d') 
			AND STR_TO_DATE(#{END_DT},'%Y%m%d') 
		</if>
		<!--고객사가 null이 아닌 경우 고객사에 따른 검색이 가능하게함  -->
		<if test='CUSTOMERNAME != null and CUSTOMERNAME != ""'>
			AND CUSTOMERNAME LIKE CONCAT("%"#{CUSTOMERNAME}"%")
		</if>
        <!--제품명이 null이 아닌 경우 제품명에 따른 검색이 가능하게함  -->
		<if test='PRODNAME != null and PRODNAME != ""'>
			AND PRODNAME LIKE CONCAT("%"#{PRODNAME}"%")
		</if>
		    ORDER BY PROD_IN_DATE
	</select>
	
	<!-- 제품출고공통 리스트 <전체> 가져오기 -->
	<select id="selectProdOutList" parameterType="hashmap"
		resultType="hashmap">
		<![CDATA[
		SELECT  PROD_OUT_NO                                            	
		 	   ,DATE_FORMAT(PROD_OUT_DATE,'%Y%m%d') AS PROD_OUT_DATE  
		 	   ,CAR_NO                                                
			   ,CAR_DRIV_NAME                                        
			   ,CAR_DRIV_TEL                                       
			   ,REMARK                                               
			   ,DEL_GBN                                             
		  FROM TB_MESPRODOUT
		  WHERE 1 = 1
		]]>  
		  <!--  삭제 구분에 N 즉 삭제된 데이터가 아닌경우 -->
		<if test='DEL_GBN != "N"'>
			AND DEL_GBN ='N'
		</if>
		<!-- 검색 날짜가 null이 아닐경우 -->
		<if test='STR_DT != null and STR_DT != ""'>
			AND PROD_IN_DATE BETWEEN STR_TO_DATE(#{STR_DT},'%Y%m%d') 
			AND STR_TO_DATE(#{END_DT},'%Y%m%d') 
		</if>
		ORDER BY PROD_OUT_DATE
	</select>
	

	<!-- 제품출고공통 추가 -->
	<select id="insertProdOutList" parameterType="hashmap"
	   resultType="java.lang.Integer">
		<![CDATA[   
		INSERT 
			INTO TB_MESPRODOUT(
  					-- CTR_CD   Field 미 존재로 인해 주석처리_gwpark               
  					PROD_OUT_NO         
  					,PROD_OUT_DATE         
  					,CAR_NO                
  					,CAR_DRIV_NAME         
  					,CAR_DRIV_TEL          
					,REMARK               
					,DEL_GBN             
					,REG_USER_ID        
					,REG_PGM_ID           
					,REG_DT                
					,UPD_USER_ID           
					,UPD_PGM_ID          
					,UPD_DT               
					)
			VALUES(
				   -- #{CTR_CD}
				   (SELECT PROD_OUT_NO + 1 AS PROD_OUT_NO FROM TB_MESPRODOUT AS SUB_TABLE ORDER BY PROD_OUT_NO DESC LIMIT 1) -- ,FN_CM_SEQ('PROD_OUT_NO', NULL, NULL)   함수 미 존재로 임시 적용_gwpark
				   ,DATE_FORMAT(#{PROD_OUT_DATE},'%Y%m%d')
				   ,#{CAR_NO}
				   ,#{CAR_DRIV_NAME}
				   ,#{CAR_DRIV_TEL}
				   ,#{REMARK}
				   ,'N'
				   ,#{REG_USER_ID}
				   ,#{REG_PGM_ID}
				   ,now()
				   ,#{UPD_USER_ID}
				   ,#{UPD_DT}
				   ,now()
				   )
			]]>	   
	</select>
	
	<!-- 제품출고공통 수정 -->
	<select id="updateProdOutList" parameterType="hashmap"
		resultType="java.lang.Integer">
		 UPDATE TB_MESPRODOUT
			SET PROD_OUT_DATE = #{PROD_OUT_DATE}
				,CAR_NO = #{CAR_NO}
				,CAR_DRIV_NAME = #{CAR_DRIV_NAME}
				,CAR_DRIV_TEL = #{CAR_DRIV_TEL}
				,REMARK = #{REMARK}
	 	  WHERE PROD_OUT_NO = #{PROD_OUT_NO}
	</select>
	
	<!-- 제품출고공통 삭제 -->
	<select id="deleteProdOutList" parameterType="hashmap"
		resultType="java.lang.Integer">
		DELETE TB_MESPRODOUT
		 WHERE PROD_OUT_NO = #{PROD_OUT_NO}
	</select>
	
	<!-- 제품출고상세 추가 -->
	<select id="insertProdOutDeltList">
		<![CDATA[   
		INSERT 
			INTO TB_MESPRODOUTDELT(
  					 --  CTR_CD Field 미 존재로 인해 주석처리_gwpark               
  					PROD_OUT_NO            
  					,PROD_OUT_NO_SEQ        
  					,PROD_OUT_DATE        
  					,PROD_IN_NO            
  					,ORDER_NO              
  					,CUSTOMERID            
  					,PRODID                 
  					,PROD_OUT_QTY          
  					,PROD_OUT_GBN          
  					,CAR_NO               
  					,CAR_DRIV_NAME         
  					,CAR_DRIV_TEL        
					,REMARK               
					,DEL_GBN              
					,REG_USER_ID          
					,REG_PGM_ID         
					,REG_DT                 
					,UPD_USER_ID          
					,UPD_PGM_ID        
					,UPD_DT              
					)
			VALUES(
				   -- #{CTR_CD}
				   (SELECT PROD_OUT_NO + 1 AS PROD_OUT_NO FROM TB_MESPRODOUT AS SUB_TABLE ORDER BY PROD_OUT_NO DESC LIMIT 1) -- ,FN_CM_SEQ('PROD_OUT_NO', NULL, NULL)   함수 미 존재로 임시 적용_gwpark
				   ,(SELECT PROD_OUT_NO_SEQ + 1 AS PROD_OUT_NO_SEQ FROM TB_MESPRODOUTDELT AS SUB_TABLE ORDER BY PROD_OUT_NO_SEQ DESC LIMIT 1)  --  ,FN_CM_SEQ('PROD_OUT_NO_SEQ', NULL, NULL) 함수 미 존재로 임시 적용_gwpark
				   ,now()
				   ,#{PROD_IN_NO}
				   ,#{ORDER_NO}
				   ,#{CUSTOMERID}
				   ,#{PRODID}
				   ,#{PROD_OUT_QTY}
				   ,#{PROD_OUT_GBN}
				   ,#{CAR_NO}
				   ,#{CAR_DRIV_NAME}
				   ,#{CAR_DRIV_TEL}
				   ,#{REMARK}
				   ,'N'
				   ,#{REG_USER_ID}
				   ,#{REG_PGM_ID}
				   ,now()
				   ,#{UPD_USER_ID}
				   ,#{UPD_DT}
				   ,now()
				   )
			]]>	
	</select>
	
</mapper>