<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtMapper">

	<!-- 설비 관리정보 -->
	<sql id="eqmtMgt_base">
			eqmtMgt.eqmt_mgt_id				AS eqmtMgtId,
			eqmtMgt.eqmt_mgt_nm             AS eqmtMgtNm,
			eqmtMgt.eqmt_mgt_purchase       AS eqmtMgtPurchase,
			eqmtMgt.eqmt_mgt_verif          AS eqmtMgtVerif,
			eqmtMgt.eqmt_mgt_desc           AS eqmtMgtDesc,
			eqmtMgt.is_use                  AS isUse,
			eqmtMgt.creator_id              AS creatorId,
			eqmtMgt.created_at              AS createdAt,
			eqmtMgt.updator_id              AS updatorId,
			eqmtMgt.updated_at              AS updatedAt,
			eqmtMgt.place_id                AS placeId,
			eqmtMgt.eqmt_mgt_std01			AS eqmtMgtStd01,
			eqmtMgt.eqmt_mgt_std02			AS eqmtMgtStd02,
			eqmtMgt.eqmt_mgt_std03			AS eqmtMgtStd03,
			eqmtMgt.eqmt_mgt_std04			AS eqmtMgtStd04,
			eqmtMgt.eqmt_mgt_std05			AS eqmtMgtStd05,
			eqmtMgt.eqmt_mgt_std_str01		AS eqmtMgtStdStr01,
			eqmtMgt.eqmt_mgt_std_str02		AS eqmtMgtStdStr02,
			eqmtMgt.eqmt_mgt_std_str03		AS eqmtMgtStdStr03,
			eqmtMgt.eqmt_mgt_std_str04		AS eqmtMgtStdStr04,
			eqmtMgt.eqmt_mgt_std_str05		AS eqmtMgtStdStr05
		FROM bc_equipment_mgt eqmtMgt
		WHERE 1=1
		<if test="searchText != null and searchText != '' ">
			AND ${searchGubun} LIKE CONCAT('%',#{searchText},'%')
		</if>
		<if test="eqmtMgtId != null and eqmtMgtId != '' ">
			AND eqmtMgt.eqmt_mgt_id = #{eqmtMgtId}
		</if>
		<if test="isUse != null and isUse != '' ">
			AND eqmtMgt.is_use = #{isUse}
		</if>
	</sql>
	
	<!-- 설비 관리정보(Page) select -->
	<select id="selectEqmtMgtList"
		parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto"
		resultType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		SELECT * FROM (
			SELECT 
				<choose>
					<when test="sort != null and sort != '' ">
						ROW_NUMBER() OVER(ORDER BY ${sort}) AS RNUM,
					</when>
					<otherwise>
						ROW_NUMBER() OVER(ORDER BY updatedAt desc) AS RNUM,
					</otherwise>
				</choose>
				<include refid="eqmtMgt_base" />
			)s_table
			<if test="firstIndex != null and firstIndex != 0 and lastIndex != null and lastIndex != 0 ">
				WHERE RNUM <![CDATA[ >= ]]> #{firstIndex} AND RNUM <![CDATA[ <= ]]> #{lastIndex}
			</if>
	</select>
	
	<!-- 설비 관리정보 Count -->
	<select id="selectEqmtMgtCount"
		parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto"
		resultType="java.lang.Integer">
				SELECT count(*) 
				FROM (
					SELECT
					<include refid="eqmtMgt_base" />
				)c_table
	</select>
	
	<!--설비상세조회 -->
	<select id="selectEqmtMgtListAll"
		parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto"
		resultType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		SELECT 
		<include refid="eqmtMgt_base" />
		AND eqmtMgt.is_use = true
	</select>
	
	<!-- 설비 관리정보 입력 -->
	<insert id="insertEqmtMgt" parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
	<selectKey keyProperty="eqmtMgtId" resultType="java.lang.String" order="BEFORE">
		SELECT CREATE_PK('EQUMG') AS eqmtMgtId
	</selectKey>
		INSERT INTO bc_equipment_mgt(
			eqmt_mgt_id,
			eqmt_mgt_nm,
			eqmt_mgt_purchase,
			eqmt_mgt_verif,
			eqmt_mgt_desc,
			is_use,
			creator_id,
			created_at,
			updator_id,
			updated_at,
			place_id,
			eqmt_mgt_std01,
			eqmt_mgt_std02,
			eqmt_mgt_std03,
			eqmt_mgt_std04,
			eqmt_mgt_std05,
			eqmt_mgt_std_str01,
			eqmt_mgt_std_str02,
			eqmt_mgt_std_str03,
			eqmt_mgt_std_str04,
			eqmt_mgt_std_str05
		)VALUES(
			#{eqmtMgtId},
			#{eqmtMgtNm},
			#{eqmtMgtPurchase},
			#{eqmtMgtVerif},
			#{eqmtMgtDesc},
			TRUE,
			#{creatorId},
			NOW(),
			#{updatorId},
			NOW(),
			#{placeId},
			#{eqmtMgtStd01},
			#{eqmtMgtStd02},
			#{eqmtMgtStd03},
			#{eqmtMgtStd04},
			#{eqmtMgtStd05},
			#{eqmtMgtStdStr01},
			#{eqmtMgtStdStr02},
			#{eqmtMgtStdStr03},
			#{eqmtMgtStdStr04},
			#{eqmtMgtStdStr05}
		)
	</insert>
	
	<!-- 설비 관리 정보수정 -->
	<update id="updateEqmtMgt" parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		UPDATE bc_equipment_mgt
		SET updator_id = #{updatorId},	
			updated_at = NOW()
			<if test="eqmtMgtNm != null">	
				,eqmt_mgt_nm = #{eqmtMgtNm}
			</if>
			<if test="eqmtMgtPurchase != null">	
				,eqmt_mgt_purchase = #{eqmtMgtPurchase}
			</if>
			<if test="eqmtMgtVerif != null">	
				,eqmt_mgt_verif = #{eqmtMgtVerif}
			</if>
			<if test="eqmtMgtDesc != null">	
				,eqmt_mgt_desc = #{eqmtMgtDesc}
			</if>
			<if test="eqmtMgtStd01 != null">	
				,eqmt_mgt_std01 = #{eqmtMgtStd01}
			</if>
			<if test="eqmtMgtStd02 != null">	
				,eqmt_mgt_std02 = #{eqmtMgtStd02}
			</if>
			<if test="eqmtMgtStd03 != null">	
				,eqmt_mgt_std03 = #{eqmtMgtStd03}
			</if>
			<if test="eqmtMgtStd04 != null">	
				,eqmt_mgt_std04 = #{eqmtMgtStd04}
			</if>
			<if test="eqmtMgtStd05 != null">	
				,eqmt_mgt_std05 = #{eqmtMgtStd05}
			</if>
			<if test="eqmtMgtStdStr01 != null">	
				,eqmt_mgt_std_str01 = #{eqmtMgtStdStr01}
			</if>
			<if test="eqmtMgtStdStr02 != null">	
				,eqmt_mgt_std_str02 = #{eqmtMgtStdStr02}
			</if>
			<if test="eqmtMgtStdStr03 != null">	
				,eqmt_mgt_std_str03 = #{eqmtMgtStdStr03}
			</if>
			<if test="eqmtMgtStdStr04 != null">	
				,eqmt_mgt_std_str04 = #{eqmtMgtStdStr04}
			</if>
			<if test="eqmtMgtStdStr05 != null">	
				,eqmt_mgt_std_str05 = #{eqmtMgtStdStr05}
			</if>
			<if test="isUse != null">	
				,is_use = #{isUse}
			</if>
			<if test="placeId != null">	
				,place_id = #{placeId}
			</if>
		WHERE eqmt_mgt_id  = #{eqmtMgtId}
	</update>
	
	<!-- 설비 관리정보 삭제 -->
	<delete id="deleteEqmtMgt" parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		DELETE FROM bc_equipment_mgt
		WHERE eqmt_mgt_id  = #{eqmtMgtId}
	</delete>

	
	<!-- 설비 정비이력 -->
	<sql id="eqmtMtnc_base">
			eqmtMtnc.eqmt_mtnc_id		AS eqmtMtncId,
			eqmtMtnc.eqmt_mtnc_start	AS eqmtMtncStart,
			eqmtMtnc.eqmt_mtnc_end		AS eqmtMtncEnd,
			eqmtMtnc.eqmt_mtnc_user		AS eqmtMtncUser,
			eqmtMtnc.eqmt_mtnc_cost		AS eqmtMtncCost,
			eqmtMtnc.eqmt_mtnc_desc		AS eqmtMtncDesc,
			eqmtMtnc.creator_id			AS creatorId,
			eqmtMtnc.created_at			AS createdAt,
			eqmtMtnc.updator_id			AS updatorId,
			eqmtMtnc.updated_at			AS updatedAt,
			eqmtMtnc.eqmt_mgt_id		AS eqmtMgtId,
			urInfo.user_nm				AS eqmtMtncUserNm
		FROM his_equipment_maintenance eqmtMtnc
		LEFT OUTER JOIN mb_user_info urInfo ON eqmtMtnc.eqmt_mtnc_user = urInfo.user_id
		WHERE eqmtMtnc.eqmt_mgt_id = #{eqmtMgtId}
		<if test="searchText != null and searchText != '' ">
			AND ${searchGubun} LIKE CONCAT('%',#{searchText},'%')
		</if>
	</sql>
	
		<!-- 설비 정비이력(Page) select -->
	<select id="selectEqmtMtncList"
		parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto"
		resultType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		SELECT * FROM (
			SELECT 
				<choose>
					<when test="sort != null and sort != '' ">
						ROW_NUMBER() OVER(ORDER BY ${sort}) AS RNUM,
					</when>
					<otherwise>
						ROW_NUMBER() OVER(ORDER BY updatedAt desc) AS RNUM,
					</otherwise>
				</choose>
				<include refid="eqmtMtnc_base" />
			)s_table
			<if test="firstIndex != null and firstIndex != 0 and lastIndex != null and lastIndex != 0 ">
				WHERE RNUM <![CDATA[ >= ]]> #{firstIndex} AND RNUM <![CDATA[ <= ]]> #{lastIndex}
			</if>
	</select>

	<!-- 설비 정비이력Count -->
	<select id="selectEqmtMtncCount"
		parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto"
		resultType="java.lang.Integer">
				SELECT count(*) 
				FROM (
					SELECT
					<include refid="eqmtMtnc_base" />
				)c_table
	</select>
	
	<!-- 설비 정비이력 입력 -->
	<insert id="insertEqmtMtnc" parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		<selectKey keyProperty="eqmtMtncId" resultType="java.lang.String" order="BEFORE">
		SELECT CREATE_PK('MTENC') AS eqmtMtncId
		</selectKey>
		INSERT INTO his_equipment_maintenance(
			eqmt_mtnc_id,
			eqmt_mtnc_start,
			eqmt_mtnc_end,
			eqmt_mtnc_user,
			eqmt_mtnc_cost,
			eqmt_mtnc_desc,
			creator_id,
			created_at,
			updator_id,
			updated_at,
			eqmt_mgt_id
		)VALUES(
			#{eqmtMtncId},
			#{eqmtMtncStart},
			#{eqmtMtncEnd},
			#{eqmtMtncUser},
			#{eqmtMtncCost},
			#{eqmtMtncDesc},
			#{creatorId},
			NOW(),
			#{updatorId},
			NOW(),
			#{eqmtMgtId}
		)
	</insert>
	
	<!-- 설비 정비이력 수정 -->
	<update id="updateEqmtMtnc" parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		UPDATE his_equipment_maintenance
		SET updator_id = #{updatorId},	
			updated_at = NOW()
			<if test="eqmtMtncStart != null">	
				,eqmt_mtnc_start = #{eqmtMtncStart}
			</if>
			<if test="eqmtMtncEnd != null">	
				,eqmt_mtnc_end = #{eqmtMtncEnd}
			</if>
			<if test="eqmtMtncUser != null">	
				,eqmt_mtnc_user = #{eqmtMtncUser}
			</if>
			<if test="eqmtMtncCost != null">	
				,eqmt_mtnc_cost = #{eqmtMtncCost}
			</if>
			<if test="eqmtMtncDesc != null">	
				,eqmt_mtnc_desc = #{eqmtMtncDesc}
			</if>
		WHERE eqmt_mtnc_id  = #{eqmtMtncId}
	</update>
	
	<!-- 설비 정비이력 삭제 -->
	<delete id="deleteEqmtMtnc" parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		DELETE FROM his_equipment_maintenance
		WHERE eqmt_mtnc_id  = #{eqmtMtncId}
	</delete>
	
	
	
	<!--설비 가동시간 -->
	<sql id="eqmtWork_base">
			eqmtWork.eqmt_work_start	AS eqmtWorkStart,
			eqmtWork.eqmt_work_end      AS eqmtWorkEnd,
			eqmtWork.eqmt_mgt_id        AS eqmtMgtId
		FROM his_equipment_work eqmtWork
		WHERE eqmtWork.eqmt_mgt_id = #{eqmtMgtId} AND DATE_FORMAT(eqmt_work_start,'%Y-%m-%d') = DATE_FORMAT(#{eqmtWorkStart},'%Y-%m-%d')
		<if test="searchText != null and searchText != '' ">
			AND ${searchGubun} LIKE CONCAT('%',#{searchText},'%')
		</if>
	</sql>
	
	<!-- 설비 가동시간(Page) select -->
	<select id="selectEqmtWorkList"
		parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto"
		resultType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		SELECT * FROM (
			SELECT 
				<choose>
					<when test="sort != null and sort != '' ">
						ROW_NUMBER() OVER(ORDER BY ${sort}) AS RNUM,
					</when>
					<otherwise>
						ROW_NUMBER() OVER(ORDER BY eqmtWorkStart desc) AS RNUM,
					</otherwise>
				</choose>
				<include refid="eqmtWork_base" />
			)s_table
		<if test="firstIndex != null and firstIndex != 0 and lastIndex != null and lastIndex != 0 ">
			WHERE RNUM <![CDATA[ >= ]]> #{firstIndex} AND RNUM <![CDATA[ <= ]]> #{lastIndex}
		</if>
	</select>

	<!-- 설비 가동시간Count -->
	<select id="selectEqmtWorkCount"
		parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto"
		resultType="java.lang.Integer">
				SELECT count(*) 
				FROM (
					SELECT
					<include refid="eqmtWork_base" />
				)c_table
	</select>
	
	<!--설비가동시간, 설비종합효율 -->
	<select id="selectEqmtOverall"
		parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto"
		resultType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		SELECT
			eqmt_mgt_id AS eqmtMgtId,
			TIME_FORMAT(SEC_TO_TIME(SUM(TIMESTAMPDIFF(SECOND ,eqmt_work_start,eqmt_work_end))), '%H 시간 %i 분 %s 초') 		AS runTime,		-- 총 가동시간
			SUM(((8*60*60)-(8*60*60 - TIMESTAMPDIFF(SECOND ,eqmt_work_start,eqmt_work_end)))/(8*60*60))					AS eqmtPercent	-- 총 종합효율
		FROM his_equipment_work eqmtWork
		WHERE eqmtWork.eqmt_mgt_id = #{eqmtMgtId} AND DATE_FORMAT(eqmt_work_start,'%Y-%m-%d') = DATE_FORMAT(#{eqmtWorkStart},'%Y-%m-%d')
		GROUP BY eqmt_mgt_id
	</select>
	
	<!-- 설비 정비이력 입력 -->
	<insert id="insertEqmtWork" parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		INSERT INTO his_equipment_work(
			prod_work_id,
			eqmt_work_start,
			eqmt_work_end,
			eqmt_mgt_id
		)VALUES(
			#{prodWorkId},
			#{eqmtWorkStart},
			#{eqmtWorkEnd},
			#{eqmtMgtId}
		)
	</insert>
	
	<!-- 설비 정비이력 수정 -->
	<update id="updateEqmtWork" parameterType="jin.mes.cform.facilMgt.facilCorMgt.ZinixFacilCorMgtDto">
		UPDATE his_equipment_work
		SET eqmt_mgt_id = eqmt_mgt_id
			<if test="eqmtWorkStart != null">
				,eqmt_work_start = #{eqmtWorkStart}
			</if>
			<if test="eqmtWorkEnd != null">
				,eqmt_work_end = #{eqmtWorkEnd}
			</if>
		WHERE eqmt_mgt_id  = #{eqmtMgtId} AND prod_work_id = #{prodWorkId}
	</update>
</mapper>