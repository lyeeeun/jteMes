<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="QUAL_returnReg">
<!-- 			       , FN_CM_GETCOMNM(O.CTR_CD , 'PRODTYPE', P.PRODTYPE) AS PRODTYPE       
			       , FN_CM_GETCOMNM(O.CTR_CD , 'PRODSPEC', P.PRODSPEC) AS PRODSPEC        
				   , FN_CM_GETCOMNM(O.CTR_CD , 'PRODUNITCD',P.PRODUNIT_CD )  AS UNIT_NM -->
	<select id="orderList" parameterType="hashmap"
		resultType="hashmap">

	<![CDATA[
		    SELECT  O.PROD_OUT_NO
			 	   ,O.ORDER_NO
			       ,O.CTR_CD
			       ,DATE_FORMAT(O.PROD_OUT_DATE,'%Y%m%d') AS PROD_OUT_DATE
			       ,O.CUSTOMERID
			       ,C.CUSTOMERNAME
			       ,O.PRODID
			       ,P.PRODNAME
			       ,O.PROD_OUT_QTY    
			       ,O.RTN_TOT_QTY    
			       ,O.PROD_OUT_QTY - O.RTN_TOT_QTY AS NOW_PROD_OUT
			       ,O.DEL_GBN
			       ,P.PRODMTRL
			       ,P.PRODTYPE      
			       ,P.PRODSPEC        
				   ,P.PRODUNIT_CD AS UNIT_NM 
			FROM TB_MESPRODOUTDELT O
			  INNER JOIN TB_PRODUCT P ON O.PRODID=P.PRODID
			  INNER JOIN TB_CUSTOMER C ON O.CUSTOMERID=C.CUSTOMERID
			 WHERE 1 = 1 
			   AND O.PROD_OUT_QTY - O.RTN_TOT_QTY > 0
			
		]]>
		<!--  삭제 구분에 N 즉 삭제된 데이터가 아닌경우 -->
		<if test='DEL_GBN != "N"'>
			AND O.DEL_GBN ='N'
		</if>
		<if test='STR_DT != null and STR_DT != ""'>
			AND DATE_FORMAT(PROD_OUT_DATE,'%Y%m%d') BETWEEN DATE_FORMAT(#{STR_DT},'%Y%m%d') 
			AND DATE_FORMAT(#{END_DT},'%Y%m%d')
		</if>
		 <!--고객사가 null이 아닌 경우 고객사에 따른 검색이 가능하게함  -->
		<if test='CUSTOMERNAME != null and CUSTOMERNAME != ""'>
				AND CUSTOMERNAME LIKE CONCAT("%"#{CUSTOMERNAME}"%") 
		</if>
        <!--제품명이 null이 아닌 경우 제품명에 따른 검색이 가능하게함  -->
		<if test='PRODNAME != null and PRODNAME != ""'>
			AND PRODNAME LIKE CONCAT("%"#{PRODNAME}"%") 
		</if>
		ORDER BY PROD_OUT_NO
	</select> 
	
	
	<!-- 반품원인 리스트 -->
	<select id="selectProductReturnList" resultType="hashmap">
		SELECT 	 COM_CD,
			     COM_NM 
		FROM     TB_COMCDINF 
		WHERE    GRP_CD = 'RETURN' 

	</select>
	
	<select id="insertList" parameterType="hashmap"
		resultType="java.lang.Integer">
		<![CDATA[
			INSERT INTO TB_MESPRODRETURN(
			                           RTN_NO               
			                          ,RTN_DATE                 
			                          ,PROD_OUT_NO             
			                          ,ORDER_NO                
			                          ,CUSTOMERID             
			                          ,PRODID                 
			                          ,RTN_QTY               
			                          ,RETURN_CAUSE_CD        
			                          ,RT_REMARK                
			                          ,DEL_GBN                  
									  ,REG_USER_ID              
									  ,REG_PGM_ID              
									  ,REG_DT                  
									  ,UPD_USER_ID              
									  ,UPD_PGM_ID              
									  ,UPD_DT                   
									  ,CTR_CD                     	                          
			                          )
			                   VALUES( 
			                   		  (SELECT RTN_NO + 1 AS RTN_NO FROM TB_MESPRODRETURN AS SUB_TABLE ORDER BY RTN_NO DESC LIMIT 1) -- FN_CM_SEQ('RTN_NO',NULL,NULL) 함수 미존재로 임시 적용
			                   		  ,now()
			                          ,#{PROD_OUT_NO}
			                          ,#{ORDER_NO}
			                          ,#{CUSTOMERID}
			                          ,#{PRODID}
			                          ,#{RTN_QTY}
			                          ,#{RETURN_CAUSE_CD}          
			                          ,#{RT_REMARK}               
			                          ,'N'
									  ,#{REG_USER_ID}
									  ,#{REG_PGM_ID}
									  ,now()
									  ,#{UPD_USER_ID}
									  ,#{UPD_PGM_ID}
									  ,now()
									  ,#{CTR_CD}
			                          )
		]]>
	</select>


	<select id="selectSave" parameterType="hashmap"
		resultType="hashmap">
		<![CDATA[
			/* 프로그램관리 _ 데이터 저장전 중복체크 */ 
			SELECT COUNT(*) AS CNT			-- 갯수
			FROM TB_MESPRODOUTDELT			-- [TB_프로그램목록]
			WHERE PROD_OUT_NO = #{PROD_OUT_NO}
		]]>
	</select>

</mapper>