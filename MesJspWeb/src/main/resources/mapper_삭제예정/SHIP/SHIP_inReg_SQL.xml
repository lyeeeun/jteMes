<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SHIP_inReg">
<!-- 			                 , FN_CM_GETCOMNM(OP.CTR_CD , 'PRODTYPE', P.PRODTYPE) AS PRODTYPE       
			                 , FN_CM_GETCOMNM(OP.CTR_CD , 'PRODSPEC', P.PRODSPEC) AS PRODSPEC        
							 , FN_CM_GETCOMNM(OP.CTR_CD , 'PRODUNITCD',P.PRODUNIT_CD )  AS UNIT_NM    -->
	<select id="selectShipInList" parameterType="hashmap"
		resultType="hashmap">
		<![CDATA[
		
			 SELECT            OP.WO_OUT_NO                                                       	
			                 , DATE_FORMAT(OP.WO_OUT_DATE,'%Y%m%d') AS WO_OUT_DATE             		
			                 , OP.WOID                                                       		 
			                 , OP.ORDER_NO                                                    		
			                 , OP.CUSTOMERID                                                 		
			                 , OP.PRODID                                                      		
			                 , C.CUSTOMERNAME                                                   	
			                 , P.PRODNAME                                                          
			                 , P.PRODMTRL                                                            
			                 , P.PRODTYPE   
			                 , P.PRODSPEC       
							 , P.PRODUNIT_CD AS UNIT_NM   
			                 , OP.SHOPFLOOR_OUT_QTY                                          		
			                 , OP.PROD_IN_TOT_QTY                                            		 
			                 , OP.SHOPFLOOR_OUT_QTY - OP.PROD_IN_TOT_QTY  AS NOW_SHOPFLOOR   		
			                 , OP.DEL_GBN                                                    		
				FROM TB_MESWORKORDEROUT OP
				INNER JOIN TB_CUSTOMER C ON OP.CUSTOMERID=C.CUSTOMERID
				INNER JOIN TB_PRODUCT P ON OP.PRODID=P.PRODID
				WHERE 1=1
				  AND OP.SHOPFLOOR_OUT_QTY - OP.PROD_IN_TOT_QTY > 0   -- 생산량-제품입고량=0 이면 리스트에서 사라짐
		]]>
		<!--  삭제 구분에 N 즉 삭제된 데이터가 아닌경우 -->
		<if test='DEL_GBN != "N"'>
			AND OP.DEL_GBN ='N'
		</if>
		<!-- 검색 날짜가 null이 아닐경우 -->
		<if test='STR_DT != null and STR_DT != ""'>
			AND WO_OUT_DATE BETWEEN STR_TO_DATE(#{STR_DT},'%Y%m%d') 
                                     AND STR_TO_DATE(#{END_DT},'%Y%m%d') 
		</if>
		<!--고객사가 null이 아닌 경우 고객사에 따른 검색이 가능하게함  -->
		<if test='CUSTOMERNAME != null and CUSTOMERNAME != ""'>
				AND CUSTOMERNAME LIKE CONCAT("%"#{CUSTOMERNAME}"%")
		</if>
        <!--제품명이 null이 아닌 경우 제품명에 따른 검색이 가능하게함  -->
		<if test='PRODNAME != null and PRODNAME != ""'>
			AND PRODNAME LIKE CONCAT("%"#{PRODNAME}"%")
		</if>
		    ORDER BY WO_OUT_NO
	</select>

	<select id="insertShipInList" parameterType="hashmap"
	   resultType="java.lang.Integer">
	   <![CDATA[
		INSERT
		  INTO TB_MESPRODIN(
		  			CTR_CD                
		  			,PROD_IN_NO              
		  			,PROD_IN_DATE            
		  			,PROD_IN_QTY            
		  			,ORDER_NO                
		  			,WO_OUT_NO              
		  			,REMARK                 
		  			,CUSTOMERID              
		  			,PRODID                  
		  			,DEL_GBN                 
					,REG_USER_ID            
					,REG_PGM_ID              
					,REG_DT                 
					,UPD_USER_ID            
					,UPD_PGM_ID               
					,UPD_DT                   
		  		)
		  	VALUES(
		  	      #{CTR_CD}
				   ,(SELECT PROD_IN_NO + 1 AS PROD_IN_NO FROM TB_MESPRODIN AS SUB_TABLE ORDER BY PROD_IN_NO DESC LIMIT 1) -- FN_CM_SEQ('PROD_IN_NO', NULL, NULL) 함수 미존재로 임시 적용 
				   ,now()
				   ,#{PROD_IN_QTY}
				   ,#{ORDER_NO}
				   ,#{WO_OUT_NO}
				   ,#{REMARK}
				   ,#{CUSTOMERID}
				   ,#{PRODID}
				   ,'N'
				   ,#{REG_USER_ID}
				   ,#{REG_PGM_ID}
				   ,now()
				   ,#{UPD_USER_ID}
				   ,#{UPD_PGM_ID}
				   ,now()
		  	      )	
		]]>		  		
	</select>
</mapper>